<section class="min-h-screen bg-gray-50 pb-8 print:bg-white print:min-h-0">
  <!-- Header (mobile only, hidden on desktop where sidebar is visible) -->
  <header class="bg-white shadow-sm sticky top-0 z-10 lg:hidden print:hidden">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-gray-900">MealPrep</h1>
      <nav class="flex gap-4">
        <a routerLink="/" class="text-gray-500 hover:text-gray-900 transition-colors">Today</a>
        <a routerLink="/weekly-plan" class="text-gray-500 hover:text-gray-900 transition-colors">Weekly Plan</a>
        <span class="text-primary font-medium">Shopping List</span>
      </nav>
    </div>
  </header>

  <!-- Shopping List Content -->
  <main class="max-w-3xl mx-auto px-4 py-6 print:max-w-none print:px-8">
    <!-- Week Navigation -->
    <div class="flex items-center justify-between mb-6 print:mb-4">
      <div class="flex items-center gap-3">
        <lucide-icon
          [img]="ShoppingCart"
          class="w-6 h-6 text-primary print:hidden"
        ></lucide-icon>
        <h2 class="text-xl font-semibold text-gray-900">Shopping List</h2>
      </div>
      <div class="flex items-center gap-2 print:hidden">
        <button
          type="button"
          (click)="onPreviousWeek()"
          class="p-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors"
          data-testid="prev-week-btn"
        >
          <lucide-icon [img]="ChevronLeft" class="w-5 h-5 text-gray-600"></lucide-icon>
        </button>
        <span class="text-sm font-medium text-gray-700 min-w-32 text-center" data-testid="week-range">
          {{ formattedDateRange() }}
        </span>
        <button
          type="button"
          (click)="onNextWeek()"
          class="p-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors"
          data-testid="next-week-btn"
        >
          <lucide-icon [img]="ChevronRight" class="w-5 h-5 text-gray-600"></lucide-icon>
        </button>
      </div>
    </div>

    <!-- Print Header (only visible when printing) -->
    <div class="hidden print:block mb-4">
      <p class="text-sm text-gray-600">Week of {{ formattedDateRange() }}</p>
    </div>

    @if (isLoading()) {
      <div class="flex justify-center items-center py-12" data-testid="loading-spinner">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    } @else if (error()) {
      <div
        class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"
        data-testid="error-message"
      >
        {{ error() }}
      </div>
    } @else if (shoppingList()) {
      <!-- Actions Bar -->
      <div class="flex items-center justify-between mb-4 print:hidden">
        <p class="text-sm text-gray-600" data-testid="total-items">
          {{ totalItems() }} items
        </p>
        <div class="flex items-center gap-2">
          <button
            type="button"
            (click)="onShowAddForm()"
            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary/90 transition-colors"
            data-testid="add-item-btn"
          >
            <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
            Add Item
          </button>
          <button
            type="button"
            (click)="onPrint()"
            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
            data-testid="print-btn"
          >
            <lucide-icon [img]="Printer" class="w-4 h-4"></lucide-icon>
            Print List
          </button>
        </div>
      </div>

      <!-- Add Custom Item Form -->
      @if (showAddForm()) {
        <div class="bg-white rounded-xl shadow-sm p-4 mb-4" data-testid="add-item-form">
          <h3 class="font-semibold text-gray-900 mb-3">Add Custom Item</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label for="itemName" class="block text-sm font-medium text-gray-700 mb-1">Item Name *</label>
              <input
                type="text"
                id="itemName"
                [(ngModel)]="newItemName"
                class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                placeholder="e.g., Apples"
                data-testid="item-name-input"
              />
            </div>
            <div>
              <label for="itemQuantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
              <input
                type="text"
                id="itemQuantity"
                [(ngModel)]="newItemQuantity"
                class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                placeholder="e.g., 2"
                data-testid="item-quantity-input"
              />
            </div>
            <div>
              <label for="itemUnit" class="block text-sm font-medium text-gray-700 mb-1">Unit (optional)</label>
              <input
                type="text"
                id="itemUnit"
                [(ngModel)]="newItemUnit"
                class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                placeholder="e.g., lbs, kg, cups"
                data-testid="item-unit-input"
              />
            </div>
            <div>
              <label for="itemCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select
                id="itemCategory"
                [(ngModel)]="newItemCategory"
                class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                data-testid="item-category-select"
              >
                @for (cat of categories; track cat) {
                  <option [value]="cat">{{ cat }}</option>
                }
              </select>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-4">
            <button
              type="button"
              (click)="onCancelAddForm()"
              class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
              data-testid="cancel-add-btn"
            >
              <lucide-icon [img]="X" class="w-4 h-4"></lucide-icon>
              Cancel
            </button>
            <button
              type="button"
              (click)="onAddCustomItem()"
              [disabled]="!newItemName.trim()"
              class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              data-testid="confirm-add-btn"
            >
              <lucide-icon [img]="Check" class="w-4 h-4"></lucide-icon>
              Add Item
            </button>
          </div>
        </div>
      }

      @if (shoppingList()!.categories.length === 0) {
        <div class="bg-white rounded-xl shadow-sm p-8 text-center" data-testid="empty-list">
          <lucide-icon [img]="ShoppingCart" class="w-12 h-12 text-gray-300 mx-auto mb-4"></lucide-icon>
          <p class="text-gray-500">No items in your shopping list.</p>
          <p class="text-sm text-gray-400 mt-1">Add recipes to your meal plan to generate a shopping list.</p>
        </div>
      } @else {
        <!-- Categories -->
        <div class="space-y-4" data-testid="shopping-categories">
          @for (category of shoppingList()!.categories; track category.category) {
            <div
              class="bg-white rounded-xl shadow-sm overflow-hidden print:shadow-none print:border print:border-gray-200"
              [attr.data-testid]="'category-' + category.category.toLowerCase()"
            >
              <!-- Category Header -->
              <div class="px-4 py-3 border-b border-gray-100 flex items-center gap-3">
                <div
                  class="w-8 h-8 rounded-lg flex items-center justify-center print:hidden"
                  [class]="getCategoryColor(category.category)"
                >
                  <lucide-icon
                    [img]="getCategoryIcon(category.category)"
                    class="w-4 h-4"
                  ></lucide-icon>
                </div>
                <h3 class="font-semibold text-gray-900">{{ category.category }}</h3>
                <span class="text-sm text-gray-500">({{ category.items.length }})</span>
              </div>

              <!-- Items List -->
              <ul class="divide-y divide-gray-50">
                @for (item of category.items; track item.id) {
                  <li
                    class="px-4 py-3 flex items-center gap-3 hover:bg-gray-50 print:hover:bg-transparent group"
                    [class.opacity-60]="item.isChecked"
                    [attr.data-testid]="'item-' + item.name.toLowerCase().replace(' ', '-')"
                  >
                    <!-- Checkbox -->
                    <button
                      type="button"
                      (click)="onToggleItem(item)"
                      class="flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors print:hidden"
                      [class]="item.isChecked
                        ? 'bg-primary border-primary text-white'
                        : 'border-gray-300 hover:border-primary'"
                      [attr.data-testid]="'toggle-' + item.id"
                    >
                      @if (item.isChecked) {
                        <lucide-icon [img]="Check" class="w-3 h-3"></lucide-icon>
                      }
                    </button>

                    <!-- Print checkbox -->
                    <span class="hidden print:inline-flex flex-shrink-0 w-4 h-4 border border-gray-400 rounded"></span>

                    <!-- Item details -->
                    <span
                      class="flex-grow"
                      [class.line-through]="item.isChecked"
                      [class.text-gray-500]="item.isChecked"
                      [class.text-gray-900]="!item.isChecked"
                    >
                      {{ item.name }}
                      @if (item.isCustom) {
                        <span class="text-xs text-primary ml-1">(custom)</span>
                      }
                    </span>

                    <!-- Quantity -->
                    <span
                      class="text-sm font-medium flex-shrink-0"
                      [class.text-gray-400]="item.isChecked"
                      [class.text-gray-500]="!item.isChecked"
                    >
                      {{ formatQuantity(item) }}
                    </span>

                    <!-- Remove button (only for custom items) -->
                    @if (item.isCustom) {
                      <button
                        type="button"
                        (click)="onRemoveItem(item)"
                        class="flex-shrink-0 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity print:hidden"
                        [attr.data-testid]="'remove-' + item.id"
                        title="Remove item"
                      >
                        <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
                      </button>
                    }
                  </li>
                }
              </ul>
            </div>
          }
        </div>
      }
    }
  </main>
</section>
